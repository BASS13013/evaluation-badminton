<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>√âvaluation EPS - CAP</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f766e">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --primary: #0f766e;
            --primary-dark: #0d5d57;
            --primary-light: #14b8a6;
            --secondary: #6366f1;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --gray-300: #d1d5db;
            --gray-400: #9ca3af;
            --gray-600: #4b5563;
            --gray-700: #374151;
            --gray-800: #1f2937;
            --gray-900: #111827;
            --radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0,0,0,0.1), 0 2px 4px -2px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -4px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Plus Jakarta Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f0fdfa 0%, #e0f2fe 100%);
            min-height: 100vh;
            color: var(--gray-800);
        }

        .app-container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        header {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            padding: 20px 30px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow-lg);
        }

        header h1 { font-size: 1.6rem; font-weight: 700; margin-bottom: 4px; }
        header p { opacity: 0.9; font-size: 0.9rem; }

        /* Activity Selector */
        .activity-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .activity-btn {
            flex: 1;
            min-width: 150px;
            padding: 16px 20px;
            border: 3px solid var(--gray-200);
            background: white;
            border-radius: var(--radius);
            cursor: pointer;
            font-family: inherit;
            transition: all 0.2s;
            text-align: center;
        }

        .activity-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .activity-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
        }

        .activity-btn .icon { font-size: 2rem; margin-bottom: 8px; }
        .activity-btn .name { font-weight: 700; font-size: 1rem; }
        .activity-btn .ca { font-size: 0.75rem; opacity: 0.8; margin-top: 4px; }

        /* Theme colors per activity */
        body.badminton { --primary: #0f766e; --primary-dark: #0d5d57; --primary-light: #14b8a6; }
        body.relais { --primary: #dc2626; --primary-dark: #b91c1c; --primary-light: #f87171; }
        body.musculation { --primary: #7c3aed; --primary-dark: #6d28d9; --primary-light: #a78bfa; }

        .tabs {
            display: flex;
            background: white;
            border-radius: var(--radius);
            padding: 6px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            gap: 4px;
            flex-wrap: wrap;
        }

        .tab {
            flex: 1;
            min-width: 90px;
            padding: 12px 14px;
            background: none;
            border: none;
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            color: var(--gray-600);
            border-radius: 8px;
            transition: all 0.2s;
            font-family: inherit;
        }

        .tab:hover { background: var(--gray-100); color: var(--gray-800); }
        .tab.active { background: var(--primary); color: white; }

        .content {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }

        .tab-content { display: none; padding: 24px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
        }

        .card h3 {
            font-size: 1.05rem;
            font-weight: 700;
            color: var(--gray-800);
            margin-bottom: 16px;
        }

        .form-row { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 180px; }
        .form-group label { display: block; font-size: 0.85rem; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; }

        input[type="text"], input[type="number"], select, textarea {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--gray-200);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary);
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary { background: var(--primary); color: white; }
        .btn-primary:hover { background: var(--primary-dark); transform: translateY(-1px); }
        .btn-secondary { background: var(--gray-200); color: var(--gray-700); }
        .btn-secondary:hover { background: var(--gray-300); }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-small { padding: 6px 12px; font-size: 0.8rem; }
        .actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }

        /* AFLP Sections */
        .aflp-section { margin-bottom: 30px; }

        .aflp-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 20px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white;
            border-radius: var(--radius) var(--radius) 0 0;
            flex-wrap: wrap;
            gap: 10px;
        }

        .aflp-header h4 { font-size: 1rem; font-weight: 700; }
        .aflp-header .points-badge {
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
        }

        .aflp-body {
            background: white;
            border: 2px solid var(--primary);
            border-top: none;
            border-radius: 0 0 var(--radius) var(--radius);
            padding: 20px;
        }

        /* Criterion blocks */
        .criterion-block {
            background: var(--gray-50);
            border: 1px solid var(--gray-200);
            border-radius: var(--radius);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .criterion-header {
            background: var(--gray-200);
            padding: 10px 16px;
            font-weight: 700;
            font-size: 0.9rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .criterion-header .weight-badge {
            background: var(--primary);
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
        }

        .criterion-desc {
            padding: 8px 16px;
            font-size: 0.8rem;
            color: var(--gray-600);
            background: white;
            border-bottom: 1px solid var(--gray-200);
        }

        .criterion-levels {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0;
        }

        .level-card {
            padding: 10px 8px;
            border-right: 1px solid var(--gray-200);
            text-align: center;
            background: white;
        }

        .level-card:last-child { border-right: none; }

        .level-card .level-number {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1rem;
            margin: 0 auto 6px;
            color: white;
        }

        .level-card.l1 .level-number { background: #ef4444; }
        .level-card.l2 .level-number { background: #f59e0b; }
        .level-card.l3 .level-number { background: #22c55e; }
        .level-card.l4 .level-number { background: #0f766e; }

        .level-card .level-desc { font-size: 0.7rem; color: var(--gray-600); line-height: 1.3; }
        .level-card .level-points { margin-top: 6px; font-weight: 700; font-size: 0.8rem; }

        /* Evaluation Grid */
        .eval-grid { width: 100%; overflow-x: auto; margin-top: 16px; }

        .eval-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .eval-table th, .eval-table td { padding: 8px 6px; text-align: center; border: 1px solid var(--gray-200); }
        .eval-table th { background: var(--primary); color: white; font-weight: 600; white-space: nowrap; }
        .eval-table th.sub { background: var(--primary-dark); font-size: 0.7rem; }

        .eval-table td.student-name {
            text-align: left;
            font-weight: 600;
            background: var(--gray-50);
            min-width: 130px;
            position: sticky;
            left: 0;
            z-index: 1;
        }

        .eval-table tr:nth-child(even) td { background: var(--gray-50); }
        .eval-table tr:nth-child(even) td.student-name { background: var(--gray-100); }
        .eval-table tr:hover td { background: #e0f2fe; }
        .eval-table tr:hover td.student-name { background: #bae6fd; }

        .degree-selector-inline { display: flex; gap: 2px; justify-content: center; }

        .degree-btn-mini {
            width: 26px;
            height: 26px;
            border: 2px solid var(--gray-300);
            background: white;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 700;
            font-size: 0.7rem;
            transition: all 0.15s;
            font-family: inherit;
        }

        .degree-btn-mini:hover { border-color: var(--primary); }
        .degree-btn-mini.selected { color: white; }
        .degree-btn-mini.d1.selected { background: #ef4444; border-color: #ef4444; }
        .degree-btn-mini.d2.selected { background: #f59e0b; border-color: #f59e0b; }
        .degree-btn-mini.d3.selected { background: #22c55e; border-color: #22c55e; }
        .degree-btn-mini.d4.selected { background: #0f766e; border-color: #0f766e; }

        .score-cell { font-weight: 700; font-size: 0.9rem; background: var(--gray-100) !important; }
        .score-cell.total { background: var(--primary) !important; color: white; }

        /* Score input for fine-tuning */
        .score-input-container {
            margin-top: 6px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 2px;
        }

        .score-input {
            width: 60px;
            padding: 4px 6px;
            border: 2px solid var(--primary);
            border-radius: 6px;
            font-size: 0.85rem;
            font-weight: 600;
            text-align: center;
            font-family: inherit;
        }

        .score-input:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(15, 118, 110, 0.2);
        }

        .score-range {
            font-size: 0.65rem;
            color: var(--gray-500);
        }

        .repartition-select {
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            font-size: 0.75rem;
            font-family: inherit;
        }

        /* Gender selector for relais */
        .gender-select {
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid var(--gray-300);
            font-size: 0.75rem;
        }

        /* Student list */
        .student-list { list-style: none; }
        .student-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 16px; border-bottom: 1px solid var(--gray-200); }
        .student-item:last-child { border-bottom: none; }
        .student-info { flex: 1; }
        .student-name-display { font-weight: 600; }
        .student-score { font-size: 0.85rem; color: var(--gray-600); }
        .note-badge { background: var(--primary); color: white; padding: 6px 14px; border-radius: 20px; font-weight: 700; font-size: 0.9rem; }

        /* Stats */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(130px, 1fr)); gap: 12px; margin-bottom: 20px; }
        .stat-card { background: white; border: 1px solid var(--gray-200); border-radius: var(--radius); padding: 16px; text-align: center; }
        .stat-value { font-size: 1.8rem; font-weight: 700; color: var(--primary); }
        .stat-label { font-size: 0.8rem; color: var(--gray-600); margin-top: 4px; }

        /* Notifications */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 14px 20px;
            background: var(--success);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            box-shadow: var(--shadow-lg);
            z-index: 9999;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        .empty-state { text-align: center; padding: 40px 20px; color: var(--gray-500); }

        /* Responsive */
        @media (max-width: 768px) {
            .app-container { padding: 10px; }
            header { padding: 16px; }
            header h1 { font-size: 1.3rem; }
            .activity-btn { min-width: 100px; padding: 12px; }
            .activity-btn .icon { font-size: 1.5rem; }
            .tab { padding: 10px; font-size: 0.75rem; }
            .tab-content { padding: 16px; }
            .criterion-levels { grid-template-columns: repeat(2, 1fr); }
            .level-card { border-bottom: 1px solid var(--gray-200); }
            .eval-table { font-size: 0.7rem; }
            .degree-btn-mini { width: 22px; height: 22px; font-size: 0.65rem; }
        }

        @media print {
            body { background: white; }
            .tabs, .actions, .btn, .activity-selector { display: none !important; }
            .content { box-shadow: none; }
        }
    </style>
</head>
<body class="badminton">
    <div class="app-container">
        <header>
            <h1>üìä √âvaluation EPS - CAP</h1>
            <p>Application multi-activit√©s avec crit√®res d√©taill√©s</p>
        </header>

        <!-- Activity Selector -->
        <div class="activity-selector">
            <button class="activity-btn active" data-activity="badminton" onclick="selectActivity('badminton')">
                <div class="icon">üè∏</div>
                <div class="name">Badminton</div>
                <div class="ca">CA4 - Opposition</div>
            </button>
            <button class="activity-btn" data-activity="relais" onclick="selectActivity('relais')">
                <div class="icon">üèÉ</div>
                <div class="name">Relais Vitesse</div>
                <div class="ca">CA1 - Performance</div>
            </button>
            <button class="activity-btn" data-activity="musculation" onclick="selectActivity('musculation')">
                <div class="icon">üí™</div>
                <div class="name">Musculation</div>
                <div class="ca">CA5 - Entretien</div>
            </button>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('classes')">üë• Classes</button>
            <button class="tab" onclick="switchTab('sequence')">üìã S√©quence (8pts)</button>
            <button class="tab" onclick="switchTab('finale')">üèÜ Finale (12pts)</button>
            <button class="tab" onclick="switchTab('results')">üìä R√©sultats</button>
            <button class="tab" onclick="switchTab('export')">üíæ Export</button>
        </div>

        <div class="content">
            <!-- TAB: Classes -->
            <div id="tab-classes" class="tab-content active">
                <div class="card">
                    <h3>‚ûï Ajouter une classe</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="className">Nom de la classe</label>
                            <input type="text" id="className" placeholder="Ex: CAP ELEC 1">
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="addClass()">Cr√©er</button>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h3>‚ûï Ajouter des √©l√®ves</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="selectClass">Classe</label>
                            <select id="selectClass"></select>
                        </div>
                        <div class="form-group">
                            <label for="studentName">Nom</label>
                            <input type="text" id="studentName" placeholder="NOM Pr√©nom">
                        </div>
                        <div class="form-group" id="genderGroup" style="display: none;">
                            <label for="studentGender">Sexe</label>
                            <select id="studentGender">
                                <option value="G">Gar√ßon</option>
                                <option value="F">Fille</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn btn-primary" onclick="addStudent()">Ajouter</button>
                        </div>
                    </div>
                    <div class="form-group" style="margin-top: 10px;">
                        <label for="bulkStudents">Ajout multiple (un par ligne, format: NOM Pr√©nom ou NOM Pr√©nom G/F)</label>
                        <textarea id="bulkStudents" rows="3" placeholder="DUPONT Jean G&#10;MARTIN Marie F"></textarea>
                        <button class="btn btn-secondary btn-small" onclick="addBulkStudents()" style="margin-top: 8px;">Ajouter tous</button>
                    </div>
                </div>

                <div id="classesList"></div>
            </div>

            <!-- TAB: Sequence -->
            <div id="tab-sequence" class="tab-content">
                <div class="card">
                    <h3 id="seqTitle">üìã √âvaluation au fil de la s√©quence (8 points)</h3>
                    <p id="seqDesc" style="color: var(--gray-600); margin-bottom: 16px;"></p>
                    <div class="form-row">
                        <div class="form-group" style="max-width: 300px;">
                            <label for="seqClass">Classe</label>
                            <select id="seqClass" onchange="loadSequenceGrid()"></select>
                        </div>
                    </div>
                </div>
                <div id="sequenceEvalContainer"></div>
            </div>

            <!-- TAB: Finale -->
            <div id="tab-finale" class="tab-content">
                <div class="card">
                    <h3 id="finTitle">üèÜ √âvaluation finale (12 points)</h3>
                    <p id="finDesc" style="color: var(--gray-600); margin-bottom: 16px;"></p>
                    <div class="form-row">
                        <div class="form-group" style="max-width: 300px;">
                            <label for="finClass">Classe</label>
                            <select id="finClass" onchange="loadFinaleGrid()"></select>
                        </div>
                    </div>
                </div>
                <div id="finaleEvalContainer"></div>
            </div>

            <!-- TAB: Results -->
            <div id="tab-results" class="tab-content">
                <div class="card">
                    <h3>üìä Statistiques</h3>
                    <div class="stats-grid" id="statsGrid"></div>
                </div>
                <div class="card">
                    <h3>üéØ R√©sultats par classe</h3>
                    <div class="form-group" style="max-width: 300px;">
                        <select id="resultsClass" onchange="displayResults()"></select>
                    </div>
                    <div id="resultsDisplay"></div>
                </div>
            </div>

            <!-- TAB: Export -->
            <div id="tab-export" class="tab-content">
                <div class="card">
                    <h3>üíæ Exporter</h3>
                    <div class="actions">
                        <button class="btn btn-primary" onclick="exportToCSV()">üì• CSV (Excel)</button>
                        <button class="btn btn-secondary" onclick="exportJSON()">üì• JSON (Backup)</button>
                    </div>
                </div>
                <div class="card">
                    <h3>üîÑ Importer</h3>
                    <input type="file" id="importFile" accept=".json" style="margin-bottom: 15px;">
                    <button class="btn btn-secondary" onclick="importJSON()">üì§ Importer</button>
                </div>
                <div class="card">
                    <h3>‚ö†Ô∏è Supprimer</h3>
                    <button class="btn btn-danger" onclick="clearAllData()">üóëÔ∏è Tout supprimer</button>
                </div>
            </div>
        </div>
    </div>

<script>
// ===== CONFIGURATION DES ACTIVIT√âS =====
const ACTIVITIES = {
    badminton: {
        name: "Badminton",
        icon: "üè∏",
        ca: "CA4",
        seqAFLPs: ['aflp4', 'aflp5'],
        finAFLPs: ['aflp1', 'aflp2'],
        needsGender: false,
        criteria: {
            aflp1: {
                name: "AFLP1 - Gain de matchs",
                maxBase: 7,
                criteria: [
                    {
                        id: "gain", name: "Gain de matchs", weight: 1/3,
                        levels: [
                            { level: 1, desc: "Aucun match gagn√©, adaptations al√©atoires", points: "0-0.5 pt" },
                            { level: 2, desc: "1/3 des matchs gagn√©s, quelques adaptations", points: "0.5-1 pt" },
                            { level: 3, desc: "2/3 des matchs gagn√©s, adaptations r√©guli√®res", points: "1-1.5 pts" },
                            { level: 4, desc: "Tous les matchs gagn√©s, adaptations permanentes", points: "1.5-2.3 pts" }
                        ]
                    },
                    {
                        id: "zone", name: "Points en zones dangereuses", weight: 1/3,
                        levels: [
                            { level: 1, desc: "Aucun point pr√®s des lignes, frappes au centre", points: "0-0.5 pt" },
                            { level: 2, desc: "Quelques points pr√®s des lignes", points: "0.5-1 pt" },
                            { level: 3, desc: "Points r√©guliers en zones dangereuses", points: "1-1.5 pts" },
                            { level: 4, desc: "Majorit√© des points en zones dangereuses", points: "1.5-2.3 pts" }
                        ]
                    },
                    {
                        id: "espace", name: "Points gagnants / espaces libres", weight: 1/3,
                        levels: [
                            { level: 1, desc: "Ne cherche pas les espaces, joue sur l'adversaire", points: "0-0.5 pt" },
                            { level: 2, desc: "Identifie parfois les espaces libres", points: "0.5-1 pt" },
                            { level: 3, desc: "Exploitation r√©guli√®re des espaces", points: "1-1.5 pts" },
                            { level: 4, desc: "Cr√©e et exploite syst√©matiquement les espaces", points: "1.5-2.3 pts" }
                        ]
                    }
                ]
            },
            aflp2: {
                name: "AFLP2 - Vari√©t√© technique",
                maxBase: 5,
                criteria: [
                    {
                        id: "variete", name: "Qualit√© et vari√©t√© des frappes", weight: 0.5,
                        levels: [
                            { level: 1, desc: "1-2 types de frappes, faible efficacit√©", points: "0-0.5 pt" },
                            { level: 2, desc: "2-3 techniques utilis√©es", points: "0.5-1.25 pts" },
                            { level: 3, desc: "Plusieurs techniques ma√Ætris√©es (4+)", points: "1.25-2 pts" },
                            { level: 4, desc: "R√©pertoire complet, grande efficacit√©", points: "2-2.5 pts" }
                        ]
                    },
                    {
                        id: "replacement", name: "Replacement apr√®s frappe", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Pas de replacement, reste sur place", points: "0-0.5 pt" },
                            { level: 2, desc: "Replacement occasionnel, en retard", points: "0.5-1.25 pts" },
                            { level: 3, desc: "Replacement r√©gulier, bonne anticipation", points: "1.25-2 pts" },
                            { level: 4, desc: "Replacement syst√©matique et rapide", points: "2-2.5 pts" }
                        ]
                    }
                ]
            },
            aflp4: {
                name: "AFLP4 - Arbitrer et Observer",
                maxBase: 4,
                criteria: [
                    {
                        id: "arbitrage", name: "Arbitrage & Respect des r√®gles", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Respecte difficilement, conteste", points: "0.5 pt" },
                            { level: 2, desc: "Respect sans grande rigueur", points: "1 pt" },
                            { level: 3, desc: "Arbitre correctement, accepte les d√©cisions", points: "1.5 pts" },
                            { level: 4, desc: "Ma√Ætrise compl√®te de l'arbitrage", points: "2 pts" }
                        ]
                    },
                    {
                        id: "observation", name: "Pr√©cision de l'observation", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Observation impr√©cise", points: "0.5 pt" },
                            { level: 2, desc: "Observation basique", points: "1 pt" },
                            { level: 3, desc: "Observation pr√©cise, identifie points forts/faibles", points: "1.5 pts" },
                            { level: 4, desc: "Observation experte, conseils pertinents", points: "2 pts" }
                        ]
                    }
                ]
            },
            aflp5: {
                name: "AFLP5 - √âchauffement",
                maxBase: 4,
                criteria: [
                    {
                        id: "general", name: "√âchauffement g√©n√©ral", weight: 0.5,
                        levels: [
                            { level: 1, desc: "√âbauche sans effets r√©els", points: "0.5 pt" },
                            { level: 2, desc: "√âchauffement global et rapide", points: "1 pt" },
                            { level: 3, desc: "Structur√© et progressif", points: "1.5 pts" },
                            { level: 4, desc: "Autonome et complet", points: "2 pts" }
                        ]
                    },
                    {
                        id: "specifique", name: "√âchauffement sp√©cifique", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Pas de pr√©paration sp√©cifique", points: "0.5 pt" },
                            { level: 2, desc: "Quelques √©changes simples", points: "1 pt" },
                            { level: 3, desc: "√âchanges progressifs en 4 temps", points: "1.5 pts" },
                            { level: 4, desc: "Pr√©paration compl√®te et autonome", points: "2 pts" }
                        ]
                    }
                ]
            }
        }
    },
    relais: {
        name: "Relais Vitesse",
        icon: "üèÉ",
        ca: "CA1",
        seqAFLPs: ['aflp3', 'aflp5'],
        finAFLPs: ['aflp1', 'aflp2'],
        needsGender: true,
        criteria: {
            aflp1: {
                name: "AFLP1 - Performance et gain de vitesse",
                maxBase: 7,
                criteria: [
                    {
                        id: "vitesse", name: "Vitesse (bar√®me G/F)", weight: 0.5,
                        description: "G: D1=17-18 D2=20-22 D3=23-24 D4=26-28 km/h | F: D1=14-16 D2=18-20 D3=21-22 D4=23-25 km/h",
                        levels: [
                            { level: 1, desc: "G: 17-18 km/h | F: 14-16 km/h", points: "0-1 pt" },
                            { level: 2, desc: "G: 20-22 km/h | F: 18-20 km/h", points: "2-3 pts" },
                            { level: 3, desc: "G: 23-24 km/h | F: 21-22 km/h", points: "4-5 pts" },
                            { level: 4, desc: "G: 26-28 km/h | F: 23-25 km/h", points: "6-7 pts" }
                        ]
                    },
                    {
                        id: "gain", name: "Gain de vitesse (relais vs d√©part arr√™t√©)", weight: 0.5,
                        description: "Diff√©rence entre vitesse relais et vitesse individuelle",
                        levels: [
                            { level: 1, desc: "+0 √† +0.5 km/h de gain", points: "0-1 pt" },
                            { level: 2, desc: "+0.5 √† +1 km/h de gain", points: "2-3 pts" },
                            { level: 3, desc: "+1.5 √† +2 km/h de gain", points: "4-5 pts" },
                            { level: 4, desc: "+2 √† +2.5 km/h de gain", points: "6-7 pts" }
                        ]
                    }
                ]
            },
            aflp2: {
                name: "AFLP2 - Transmission du t√©moin",
                maxBase: 5,
                criteria: [
                    {
                        id: "technique", name: "Technique de transmission", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Technique inadapt√©e, non anticip√©e, arr√™t", points: "0-0.5 pt" },
                            { level: 2, desc: "Technique al√©atoire, dissociation difficile", points: "1-2 pts" },
                            { level: 3, desc: "Technique efficace, bonne dissociation regard/main", points: "2.5-4 pts" },
                            { level: 4, desc: "Technique efficace et rapide au signal convenu", points: "4.5-5 pts" }
                        ]
                    },
                    {
                        id: "zone", name: "Utilisation de la zone", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Transmission hors zone ou √† l'arr√™t", points: "0-0.5 pt" },
                            { level: 2, desc: "Transmission en fin de zone, ralentissement", points: "1-2 pts" },
                            { level: 3, desc: "Transmission au milieu de zone, vitesse maintenue", points: "2.5-4 pts" },
                            { level: 4, desc: "Transmission optimale, pleine vitesse", points: "4.5-5 pts" }
                        ]
                    }
                ]
            },
            aflp3: {
                name: "AFLP3 - Engagement et pers√©v√©rance",
                maxBase: 4,
                criteria: [
                    {
                        id: "participation", name: "Participation aux s√©ances", weight: 0.5,
                        levels: [
                            { level: 1, desc: "S√©ances enti√®res non faites", points: "0.5 pt" },
                            { level: 2, desc: "Participation parfois al√©atoire", points: "1 pt" },
                            { level: 3, desc: "Participation satisfaisante", points: "1.5 pts" },
                            { level: 4, desc: "Participation r√©guli√®re et compl√®te", points: "2 pts" }
                        ]
                    },
                    {
                        id: "intensite", name: "Intensit√© de l'engagement", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Ne peut pas r√©p√©ter les efforts", points: "0.5 pt" },
                            { level: 2, desc: "Difficult√© √† maintenir l'intensit√©", points: "1 pt" },
                            { level: 3, desc: "Capable de mettre de l'intensit√© r√©guli√®rement", points: "1.5 pts" },
                            { level: 4, desc: "Engagement collectif constant et communicatif", points: "2 pts" }
                        ]
                    }
                ]
            },
            aflp5: {
                name: "AFLP5 - √âchauffement",
                maxBase: 4,
                criteria: [
                    {
                        id: "structure", name: "Structure de l'√©chauffement", weight: 0.5,
                        levels: [
                            { level: 1, desc: "√âbauche sans effets r√©els", points: "0.5 pt" },
                            { level: 2, desc: "√âchauffement global et rapide", points: "1 pt" },
                            { level: 3, desc: "Structur√© en diff√©rentes √©tapes avec guidance", points: "1.5 pts" },
                            { level: 4, desc: "Structur√© et complet de mani√®re autonome", points: "2 pts" }
                        ]
                    },
                    {
                        id: "specifique", name: "Pr√©paration sp√©cifique sprint", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Pas de gammes athl√©tiques", points: "0.5 pt" },
                            { level: 2, desc: "Quelques gammes approximatives", points: "1 pt" },
                            { level: 3, desc: "Gammes progressives et adapt√©es", points: "1.5 pts" },
                            { level: 4, desc: "Routine compl√®te avec acc√©l√©rations progressives", points: "2 pts" }
                        ]
                    }
                ]
            }
        }
    },
    musculation: {
        name: "Musculation",
        icon: "üí™",
        ca: "CA5",
        seqAFLPs: ['aflp4', 'aflp5'],
        finAFLPs: ['aflp1', 'aflp2'],
        needsGender: false,
        criteria: {
            aflp1: {
                name: "AFLP1 - Motricit√© sp√©cifique",
                maxBase: 7,
                criteria: [
                    {
                        id: "parametres", name: "Ma√Ætrise des param√®tres du mouvement", weight: 0.5,
                        description: "Placement, amplitude, trajet moteur, respiration",
                        levels: [
                            { level: 1, desc: "Ma√Ætrise partielle des param√®tres, ex√©cution approximative", points: "0-1 pt" },
                            { level: 2, desc: "Ma√Ætrise al√©atoire, quelques erreurs techniques", points: "1.5-3 pts" },
                            { level: 3, desc: "Ma√Ætrise de tous les param√®tres du mouvement", points: "3.5-5 pts" },
                            { level: 4, desc: "Ma√Ætrise parfaite avec rythme et fluidit√©", points: "5.5-7 pts" }
                        ]
                    },
                    {
                        id: "respiration", name: "Coordination et respiration", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Respiration anarchique, apn√©e fr√©quente", points: "0-1 pt" },
                            { level: 2, desc: "Respiration parfois coordonn√©e", points: "1.5-3 pts" },
                            { level: 3, desc: "Respiration coordonn√©e au mouvement", points: "3.5-5 pts" },
                            { level: 4, desc: "Respiration optimale, rythme ma√Ætris√©", points: "5.5-7 pts" }
                        ]
                    }
                ]
            },
            aflp2: {
                name: "AFLP2 - Ressentis et charge de travail",
                maxBase: 5,
                criteria: [
                    {
                        id: "ressentis", name: "Identification des ressentis", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Ressentis ne correspondent pas √† la r√©alit√©", points: "0-0.5 pt" },
                            { level: 2, desc: "Rel√®ve de fa√ßon formelle, ne se sert pas des infos", points: "1-2 pts" },
                            { level: 3, desc: "Identifie ses ressentis avec vocabulaire adapt√©", points: "2.5-4 pts" },
                            { level: 4, desc: "Identifie avec pr√©cision (champ lexical sp√©cifique)", points: "4.5-5 pts" }
                        ]
                    },
                    {
                        id: "regulation", name: "R√©gulation de la charge", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Ne r√©gule pas sa charge de travail", points: "0-0.5 pt" },
                            { level: 2, desc: "R√©gulation al√©atoire", points: "1-2 pts" },
                            { level: 3, desc: "R√©gule en fonction des ressentis", points: "2.5-4 pts" },
                            { level: 4, desc: "R√©gulation fine et argument√©e", points: "4.5-5 pts" }
                        ]
                    }
                ]
            },
            aflp4: {
                name: "AFLP4 - Coach / Observateur",
                maxBase: 4,
                criteria: [
                    {
                        id: "securite", name: "Parade et s√©curit√©", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Ne se sent pas concern√© par la s√©curit√©", points: "0.5 pt" },
                            { level: 2, desc: "S√©curise de mani√®re impr√©cise", points: "1 pt" },
                            { level: 3, desc: "Pare activement et r√©guli√®rement", points: "1.5 pts" },
                            { level: 4, desc: "Anticipe les situations √† risque", points: "2 pts" }
                        ]
                    },
                    {
                        id: "conseil", name: "Observation et conseils", weight: 0.5,
                        levels: [
                            { level: 1, desc: "N'observe pas, pas de retour", points: "0.5 pt" },
                            { level: 2, desc: "Observation impr√©cise, retours vagues", points: "1 pt" },
                            { level: 3, desc: "Observe et donne des retours pertinents", points: "1.5 pts" },
                            { level: 4, desc: "Coaching expert, conseils personnalis√©s", points: "2 pts" }
                        ]
                    }
                ]
            },
            aflp5: {
                name: "AFLP5 - Engagement et intensit√©",
                maxBase: 4,
                criteria: [
                    {
                        id: "regularite", name: "R√©gularit√© de l'entra√Ænement", weight: 0.5,
                        levels: [
                            { level: 1, desc: "S'entra√Æne de fa√ßon sporadique", points: "0.5 pt" },
                            { level: 2, desc: "S'entra√Æne mais pas assez de temps de travail effectif", points: "1 pt" },
                            { level: 3, desc: "S'entra√Æne √† chaque s√©ance pour ajuster sa charge", points: "1.5 pts" },
                            { level: 4, desc: "S'entra√Æne √† chaque s√©ance avec intention de progr√®s", points: "2 pts" }
                        ]
                    },
                    {
                        id: "charge", name: "Mobilisation de la charge optimale", weight: 0.5,
                        levels: [
                            { level: 1, desc: "Mobilise faiblement les ressources", points: "0.5 pt" },
                            { level: 2, desc: "Mobilise partiellement ses ressources", points: "1 pt" },
                            { level: 3, desc: "Travaille √† charge optimale selon l'objectif", points: "1.5 pts" },
                            { level: 4, desc: "Cherche constamment √† progresser", points: "2 pts" }
                        ]
                    }
                ]
            }
        }
    }
};

const REPARTITIONS = [
    { label: "4/4", coef1: 1, coef2: 1 },
    { label: "2/6", coef1: 0.5, coef2: 1.5 },
    { label: "6/2", coef1: 1.5, coef2: 0.5 }
];

// ===== STATE =====
let currentActivity = 'badminton';

// ===== DATA MANAGER =====
class DataManager {
    constructor() {
        this.storageKey = 'eps_eval_multi_v1';
        this.data = this.loadData();
    }

    loadData() {
        const stored = localStorage.getItem(this.storageKey);
        return stored ? JSON.parse(stored) : { classes: [], students: [], evaluations: {}, version: '1.0' };
    }

    saveData() { localStorage.setItem(this.storageKey, JSON.stringify(this.data)); }

    addClass(name) {
        const id = 'c_' + Date.now();
        this.data.classes.push({ id, name });
        this.saveData();
        return id;
    }

    getClasses() { return this.data.classes; }

    deleteClass(id) {
        this.data.classes = this.data.classes.filter(c => c.id !== id);
        const sids = this.data.students.filter(s => s.classId === id).map(s => s.id);
        this.data.students = this.data.students.filter(s => s.classId !== id);
        sids.forEach(sid => delete this.data.evaluations[sid]);
        this.saveData();
    }

    addStudent(classId, name, gender = 'G') {
        const id = 's_' + Date.now() + '_' + Math.random().toString(36).substr(2, 4);
        this.data.students.push({ id, classId, name, gender, repartition: {} });
        this.data.evaluations[id] = {};
        this.saveData();
        return id;
    }

    getStudentsByClass(classId) { return this.data.students.filter(s => s.classId === classId); }
    getAllStudents() { return this.data.students; }
    getStudent(id) { return this.data.students.find(s => s.id === id); }

    deleteStudent(id) {
        this.data.students = this.data.students.filter(s => s.id !== id);
        delete this.data.evaluations[id];
        this.saveData();
    }

    setRepartition(studentId, activity, rep) {
        const s = this.getStudent(studentId);
        if (s) {
            if (!s.repartition) s.repartition = {};
            s.repartition[activity] = rep;
            this.saveData();
        }
    }

    getRepartition(studentId, activity) {
        const s = this.getStudent(studentId);
        return s?.repartition?.[activity] || 0;
    }

    setEval(studentId, activity, aflp, criterion, level, customScore = null) {
        if (!this.data.evaluations[studentId]) this.data.evaluations[studentId] = {};
        if (!this.data.evaluations[studentId][activity]) this.data.evaluations[studentId][activity] = {};
        if (!this.data.evaluations[studentId][activity][aflp]) this.data.evaluations[studentId][activity][aflp] = {};
        
        // Store both level and custom score
        this.data.evaluations[studentId][activity][aflp][criterion] = {
            level: level,
            score: customScore
        };
        this.saveData();
    }

    setEvalScore(studentId, activity, aflp, criterion, score) {
        if (!this.data.evaluations[studentId]?.[activity]?.[aflp]?.[criterion]) return;
        this.data.evaluations[studentId][activity][aflp][criterion].score = score;
        this.saveData();
    }

    getEval(studentId, activity, aflp) {
        return this.data.evaluations[studentId]?.[activity]?.[aflp] || {};
    }

    getEvalLevel(studentId, activity, aflp, criterion) {
        const evalData = this.getEval(studentId, activity, aflp)[criterion];
        if (!evalData) return 0;
        // Support old format (just number) and new format (object)
        if (typeof evalData === 'number') return evalData;
        return evalData.level || 0;
    }

    getEvalScore(studentId, activity, aflp, criterion, criterionConfig, aflpMaxBase) {
        const evalData = this.getEval(studentId, activity, aflp)[criterion];
        if (!evalData) return 0;
        
        // Support old format (just number)
        if (typeof evalData === 'number') {
            return evalData * criterionConfig.weight * (aflpMaxBase / 4);
        }
        
        // New format with custom score
        if (evalData.score !== null && evalData.score !== undefined) {
            return evalData.score;
        }
        
        // Default calculation based on level
        const level = evalData.level || 0;
        return level * criterionConfig.weight * (aflpMaxBase / 4);
    }

    calcAFLPScore(studentId, activity, aflpKey, isSequence = false, aflpIndex = 0) {
        const actConfig = ACTIVITIES[activity];
        const config = actConfig.criteria[aflpKey];
        if (!config) return 0;

        let score = 0;

        config.criteria.forEach(criterion => {
            score += this.getEvalScore(studentId, activity, aflpKey, criterion.id, criterion, config.maxBase);
        });

        // Apply coefficient for sequence AFLPs
        if (isSequence) {
            const rep = this.getRepartition(studentId, activity);
            const coef = aflpIndex === 0 ? REPARTITIONS[rep].coef1 : REPARTITIONS[rep].coef2;
            score = score * coef;
        }

        return Math.round(score * 10) / 10;
    }

    getSeqScore(studentId, activity) {
        const actConfig = ACTIVITIES[activity];
        let total = 0;
        actConfig.seqAFLPs.forEach((aflp, i) => {
            total += this.calcAFLPScore(studentId, activity, aflp, true, i);
        });
        return Math.round(total * 10) / 10;
    }

    getFinScore(studentId, activity) {
        const actConfig = ACTIVITIES[activity];
        let total = 0;
        actConfig.finAFLPs.forEach(aflp => {
            total += this.calcAFLPScore(studentId, activity, aflp, false);
        });
        return Math.round(total * 10) / 10;
    }

    getTotalScore(studentId, activity) {
        return Math.round((this.getSeqScore(studentId, activity) + this.getFinScore(studentId, activity)) * 10) / 10;
    }

    clearAll() {
        if (confirm('‚ö†Ô∏è Supprimer TOUTES les donn√©es ?')) {
            localStorage.removeItem(this.storageKey);
            location.reload();
        }
    }

    exportJSON() { return JSON.stringify(this.data, null, 2); }

    importJSON(json) {
        try {
            const d = JSON.parse(json);
            if (d.classes && d.students) {
                this.data = d;
                this.saveData();
                return true;
            }
        } catch (e) {}
        return false;
    }
}

const dm = new DataManager();

// ===== ACTIVITY SELECTION =====
function selectActivity(activity) {
    currentActivity = activity;
    document.body.className = activity;
    
    // Update active button using data-activity
    document.querySelectorAll('.activity-btn').forEach(btn => {
        btn.classList.remove('active');
        if (btn.dataset.activity === activity) {
            btn.classList.add('active');
        }
    });

    // Update gender field visibility
    const genderGroup = document.getElementById('genderGroup');
    if (genderGroup) {
        genderGroup.style.display = ACTIVITIES[activity].needsGender ? 'block' : 'none';
    }

    // Update descriptions
    const actConfig = ACTIVITIES[activity];
    const seqDesc = document.getElementById('seqDesc');
    const finDesc = document.getElementById('finDesc');
    
    if (seqDesc && actConfig.criteria[actConfig.seqAFLPs[0]] && actConfig.criteria[actConfig.seqAFLPs[1]]) {
        seqDesc.textContent = `${actConfig.criteria[actConfig.seqAFLPs[0]].name} + ${actConfig.criteria[actConfig.seqAFLPs[1]].name}`;
    }
    if (finDesc && actConfig.criteria[actConfig.finAFLPs[0]] && actConfig.criteria[actConfig.finAFLPs[1]]) {
        finDesc.textContent = `${actConfig.criteria[actConfig.finAFLPs[0]].name} + ${actConfig.criteria[actConfig.finAFLPs[1]].name}`;
    }

    // Clear and refresh evaluation containers
    // Refresh views
    updateClassesList();
    updateAllSelects();
    
    // Reload grids if a class is already selected
    const seqClass = document.getElementById('seqClass');
    const finClass = document.getElementById('finClass');
    
    if (seqClass && seqClass.value) {
        loadSequenceGrid();
    } else {
        document.getElementById('sequenceEvalContainer').innerHTML = '<div class="empty-state">S√©lectionnez une classe</div>';
    }
    
    if (finClass && finClass.value) {
        loadFinaleGrid();
    } else {
        document.getElementById('finaleEvalContainer').innerHTML = '<div class="empty-state">S√©lectionnez une classe</div>';
    }
}

// ===== UI FUNCTIONS =====
function switchTab(tabName) {
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // Find and activate the clicked tab
    document.querySelectorAll('.tab').forEach(t => {
        if (t.getAttribute('onclick')?.includes(tabName)) {
            t.classList.add('active');
        }
    });
    
    document.getElementById('tab-' + tabName).classList.add('active');

    updateAllSelects();
    if (tabName === 'classes') updateClassesList();
    else if (tabName === 'results') { displayStats(); displayResults(); }
}

function addClass() {
    const name = document.getElementById('className').value.trim();
    if (!name) return alert('Entrez un nom');
    dm.addClass(name);
    document.getElementById('className').value = '';
    updateClassesList();
    updateAllSelects();
    showNotification('Classe cr√©√©e !');
}

function addStudent() {
    const classId = document.getElementById('selectClass').value;
    const name = document.getElementById('studentName').value.trim();
    const gender = document.getElementById('studentGender').value;
    if (!classId) return alert('Choisissez une classe');
    if (!name) return alert('Entrez un nom');
    dm.addStudent(classId, name, gender);
    document.getElementById('studentName').value = '';
    updateClassesList();
    showNotification('√âl√®ve ajout√© !');
}

function addBulkStudents() {
    const classId = document.getElementById('selectClass').value;
    const lines = document.getElementById('bulkStudents').value.split('\n').filter(l => l.trim());
    if (!classId) return alert('Choisissez une classe');
    if (!lines.length) return alert('Entrez des noms');

    lines.forEach(line => {
        const parts = line.trim().split(/\s+/);
        let gender = 'G';
        let name = line.trim();
        
        if (parts.length > 1) {
            const last = parts[parts.length - 1].toUpperCase();
            if (last === 'G' || last === 'F') {
                gender = last;
                name = parts.slice(0, -1).join(' ');
            }
        }
        dm.addStudent(classId, name, gender);
    });

    document.getElementById('bulkStudents').value = '';
    updateClassesList();
    showNotification(`${lines.length} √©l√®ve(s) ajout√©(s) !`);
}

function deleteClass(id) {
    if (confirm('Supprimer cette classe ?')) {
        dm.deleteClass(id);
        updateClassesList();
        updateAllSelects();
    }
}

function deleteStudent(id) {
    if (confirm('Supprimer ?')) {
        dm.deleteStudent(id);
        updateClassesList();
    }
}

function updateClassesList() {
    const classes = dm.getClasses();
    const container = document.getElementById('classesList');
    const actConfig = ACTIVITIES[currentActivity];

    if (!classes.length) {
        container.innerHTML = '<div class="empty-state">Aucune classe</div>';
        return;
    }

    container.innerHTML = classes.map(c => {
        const students = dm.getStudentsByClass(c.id);
        return `
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <h3 style="margin: 0;">${c.name}</h3>
                    <button class="btn btn-danger btn-small" onclick="deleteClass('${c.id}')">üóëÔ∏è</button>
                </div>
                <p style="color: var(--gray-600); margin-bottom: 12px;">${students.length} √©l√®ve(s)</p>
                ${students.length ? `
                    <ul class="student-list">
                        ${students.map(s => `
                            <li class="student-item">
                                <div class="student-info">
                                    <div class="student-name-display">${s.name} ${actConfig.needsGender ? `(${s.gender})` : ''}</div>
                                    <div class="student-score">${actConfig.name}: ${dm.getTotalScore(s.id, currentActivity)}/20</div>
                                </div>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <span class="note-badge">${dm.getTotalScore(s.id, currentActivity)}</span>
                                    <button class="btn btn-danger btn-small" onclick="deleteStudent('${s.id}')">üóëÔ∏è</button>
                                </div>
                            </li>
                        `).join('')}
                    </ul>
                ` : ''}
            </div>
        `;
    }).join('');
}

// ===== EVALUATION GRIDS =====
function loadSequenceGrid() {
    const classId = document.getElementById('seqClass').value;
    const container = document.getElementById('sequenceEvalContainer');
    if (!classId) { container.innerHTML = '<div class="empty-state">S√©lectionnez une classe</div>'; return; }

    const students = dm.getStudentsByClass(classId);
    if (!students.length) { container.innerHTML = '<div class="empty-state">Aucun √©l√®ve</div>'; return; }

    const actConfig = ACTIVITIES[currentActivity];
    let html = actConfig.seqAFLPs.map((aflp, i) => renderAFLPSection(aflp, students, true, i)).join('');
    html += `<div class="actions" style="justify-content: center;"><button class="btn btn-success" onclick="showNotification('Sauvegard√© !')">üíæ Donn√©es sauvegard√©es automatiquement</button></div>`;
    container.innerHTML = html;
}

function loadFinaleGrid() {
    const classId = document.getElementById('finClass').value;
    const container = document.getElementById('finaleEvalContainer');
    if (!classId) { container.innerHTML = '<div class="empty-state">S√©lectionnez une classe</div>'; return; }

    const students = dm.getStudentsByClass(classId);
    if (!students.length) { container.innerHTML = '<div class="empty-state">Aucun √©l√®ve</div>'; return; }

    const actConfig = ACTIVITIES[currentActivity];
    let html = actConfig.finAFLPs.map(aflp => renderAFLPSection(aflp, students, false)).join('');
    html += `<div class="actions" style="justify-content: center;"><button class="btn btn-success" onclick="showNotification('Sauvegard√© !')">üíæ Donn√©es sauvegard√©es automatiquement</button></div>`;
    container.innerHTML = html;
}

function renderAFLPSection(aflpKey, students, isSequence, aflpIndex = 0) {
    const actConfig = ACTIVITIES[currentActivity];
    const config = actConfig.criteria[aflpKey];

    let html = `
        <div class="aflp-section">
            <div class="aflp-header">
                <h4>${config.name}</h4>
                <span class="points-badge">${config.maxBase} pts${isSequence ? ' (base)' : ''}</span>
            </div>
            <div class="aflp-body">
    `;

    // Criteria descriptions
    config.criteria.forEach(criterion => {
        html += `
            <div class="criterion-block">
                <div class="criterion-header">
                    <span>${criterion.name}</span>
                    <span class="weight-badge">${Math.round(criterion.weight * 100)}%</span>
                </div>
                ${criterion.description ? `<div class="criterion-desc">${criterion.description}</div>` : ''}
                <div class="criterion-levels">
                    ${criterion.levels.map(l => `
                        <div class="level-card l${l.level}">
                            <div class="level-number">${l.level}</div>
                            <div class="level-desc">${l.desc}</div>
                            <div class="level-points">${l.points}</div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    });

    // Evaluation table
    html += `
        <h4 style="margin: 16px 0 10px;">üìù Saisie</h4>
        <div class="eval-grid">
            <table class="eval-table">
                <thead>
                    <tr>
                        <th>√âl√®ve</th>
                        ${isSequence && aflpIndex === 0 ? '<th>R√©part.</th>' : ''}
                        ${config.criteria.map(c => `<th class="sub">${c.name.split(' ')[0]}<br><small>Niveau + Note</small></th>`).join('')}
                        <th>Score</th>
                    </tr>
                </thead>
                <tbody>
    `;

    students.forEach(student => {
        const score = dm.calcAFLPScore(student.id, currentActivity, aflpKey, isSequence, aflpIndex);

        html += `<tr><td class="student-name">${student.name}</td>`;

        if (isSequence && aflpIndex === 0) {
            const rep = dm.getRepartition(student.id, currentActivity);
            html += `<td><select class="repartition-select" onchange="setRep('${student.id}', this.value)">
                ${REPARTITIONS.map((r, i) => `<option value="${i}" ${rep === i ? 'selected' : ''}>${r.label}</option>`).join('')}
            </select></td>`;
        }

        config.criteria.forEach((criterion, cIdx) => {
            const level = dm.getEvalLevel(student.id, currentActivity, aflpKey, criterion.id);
            const currentScore = dm.getEvalScore(student.id, currentActivity, aflpKey, criterion.id, criterion, config.maxBase);
            
            // Calculate min/max for this criterion based on level
            const maxForCriterion = criterion.weight * config.maxBase;
            const stepSize = maxForCriterion / 4;
            const minScore = level > 0 ? (level - 1) * stepSize : 0;
            const maxScore = level > 0 ? level * stepSize : maxForCriterion;
            
            html += `<td>
                <div class="degree-selector-inline">
                    ${[1,2,3,4].map(d => `<button class="degree-btn-mini d${d} ${level === d ? 'selected' : ''}" 
                        onclick="setDeg('${student.id}','${aflpKey}','${criterion.id}',${d},this,${isSequence},${aflpIndex},${cIdx})">${d}</button>`).join('')}
                </div>
                <div class="score-input-container" id="input-${student.id}-${aflpKey}-${criterion.id}" ${level === 0 ? 'style="display:none"' : ''}>
                    <input type="number" 
                        class="score-input" 
                        value="${currentScore.toFixed(1)}" 
                        min="${minScore.toFixed(1)}" 
                        max="${maxScore.toFixed(1)}" 
                        step="0.5"
                        data-student="${student.id}"
                        data-aflp="${aflpKey}"
                        data-criterion="${criterion.id}"
                        data-isseq="${isSequence}"
                        data-aflpidx="${aflpIndex}"
                        onchange="setScore(this)">
                    <span class="score-range">(${minScore.toFixed(1)}-${maxScore.toFixed(1)})</span>
                </div>
            </td>`;
        });

        html += `<td class="score-cell" id="sc-${student.id}-${aflpKey}">${score}</td></tr>`;
    });

    html += '</tbody></table></div></div></div>';
    return html;
}

function setDeg(studentId, aflp, criterion, level, btn, isSeq, aflpIdx, criterionIdx) {
    const actConfig = ACTIVITIES[currentActivity];
    const config = actConfig.criteria[aflp];
    const criterionConfig = config.criteria[criterionIdx];
    
    const currentLevel = dm.getEvalLevel(studentId, currentActivity, aflp, criterion);
    const newLevel = currentLevel === level ? 0 : level;
    
    // Calculate default score for this level
    const maxForCriterion = criterionConfig.weight * config.maxBase;
    const stepSize = maxForCriterion / 4;
    const defaultScore = newLevel > 0 ? (newLevel - 0.5) * stepSize : 0; // Middle of the range
    
    dm.setEval(studentId, currentActivity, aflp, criterion, newLevel, newLevel > 0 ? defaultScore : null);

    // Update buttons
    btn.closest('td').querySelectorAll('.degree-btn-mini').forEach((b, i) => {
        b.classList.toggle('selected', newLevel === i + 1);
    });

    // Show/hide and update score input
    const inputContainer = document.getElementById(`input-${studentId}-${aflp}-${criterion}`);
    if (inputContainer) {
        if (newLevel > 0) {
            inputContainer.style.display = 'block';
            const input = inputContainer.querySelector('input');
            const minScore = (newLevel - 1) * stepSize;
            const maxScore = newLevel * stepSize;
            input.min = minScore.toFixed(1);
            input.max = maxScore.toFixed(1);
            input.value = defaultScore.toFixed(1);
            inputContainer.querySelector('.score-range').textContent = `(${minScore.toFixed(1)}-${maxScore.toFixed(1)})`;
        } else {
            inputContainer.style.display = 'none';
        }
    }

    // Update AFLP score
    const score = dm.calcAFLPScore(studentId, currentActivity, aflp, isSeq, aflpIdx);
    document.getElementById(`sc-${studentId}-${aflp}`).textContent = score;
}

function setScore(input) {
    const studentId = input.dataset.student;
    const aflp = input.dataset.aflp;
    const criterion = input.dataset.criterion;
    const isSeq = input.dataset.isseq === 'true';
    const aflpIdx = parseInt(input.dataset.aflpidx);
    
    let score = parseFloat(input.value);
    const min = parseFloat(input.min);
    const max = parseFloat(input.max);
    
    // Clamp value
    if (score < min) score = min;
    if (score > max) score = max;
    input.value = score.toFixed(1);
    
    // Save
    dm.setEvalScore(studentId, currentActivity, aflp, criterion, score);
    
    // Update AFLP score
    const totalScore = dm.calcAFLPScore(studentId, currentActivity, aflp, isSeq, aflpIdx);
    document.getElementById(`sc-${studentId}-${aflp}`).textContent = totalScore;
}

function setRep(studentId, rep) {
    dm.setRepartition(studentId, currentActivity, parseInt(rep));
    loadSequenceGrid(); // Refresh to recalculate all sequence scores
}

// ===== RESULTS =====
function displayStats() {
    const students = dm.getAllStudents();
    let total = 0, count = 0;
    students.forEach(s => {
        const score = dm.getTotalScore(s.id, currentActivity);
        if (score > 0) { total += score; count++; }
    });

    document.getElementById('statsGrid').innerHTML = `
        <div class="stat-card"><div class="stat-value">${dm.getClasses().length}</div><div class="stat-label">Classes</div></div>
        <div class="stat-card"><div class="stat-value">${students.length}</div><div class="stat-label">√âl√®ves</div></div>
        <div class="stat-card"><div class="stat-value">${count}</div><div class="stat-label">√âvalu√©s</div></div>
        <div class="stat-card"><div class="stat-value">${count ? (total/count).toFixed(1) : 0}</div><div class="stat-label">Moyenne</div></div>
    `;
}

function displayResults() {
    const classId = document.getElementById('resultsClass').value;
    const container = document.getElementById('resultsDisplay');
    let students = classId ? dm.getStudentsByClass(classId) : dm.getAllStudents();

    if (!students.length) { container.innerHTML = '<div class="empty-state">Aucun √©l√®ve</div>'; return; }

    students.sort((a, b) => dm.getTotalScore(b.id, currentActivity) - dm.getTotalScore(a.id, currentActivity));
    const actConfig = ACTIVITIES[currentActivity];

    container.innerHTML = `<ul class="student-list">${students.map((s, i) => {
        const c = dm.getClasses().find(cl => cl.id === s.classId);
        return `<li class="student-item">
            <div class="student-info">
                <div class="student-name-display">#${i+1} ${s.name} ${actConfig.needsGender ? `(${s.gender})` : ''}</div>
                <div class="student-score">${c?.name || ''} | S√©q: ${dm.getSeqScore(s.id, currentActivity)}/8 | Fin: ${dm.getFinScore(s.id, currentActivity)}/12</div>
            </div>
            <span class="note-badge">${dm.getTotalScore(s.id, currentActivity)}/20</span>
        </li>`;
    }).join('')}</ul>`;
}

// ===== EXPORT =====
function exportToCSV() {
    const students = dm.getAllStudents();
    const classes = dm.getClasses();
    const actConfig = ACTIVITIES[currentActivity];

    let headers = ['Classe', 'Nom'];
    if (actConfig.needsGender) headers.push('Sexe');
    headers.push('R√©partition');

    actConfig.seqAFLPs.forEach(aflp => {
        actConfig.criteria[aflp].criteria.forEach(c => headers.push(`${aflp}_${c.id}_Niveau`, `${aflp}_${c.id}_Note`));
        headers.push(`Score_${aflp}`);
    });
    actConfig.finAFLPs.forEach(aflp => {
        actConfig.criteria[aflp].criteria.forEach(c => headers.push(`${aflp}_${c.id}_Niveau`, `${aflp}_${c.id}_Note`));
        headers.push(`Score_${aflp}`);
    });
    headers.push('Note_S√©quence', 'Note_Finale', 'Note_Totale');

    let csv = headers.join(',') + '\n';

    students.forEach(s => {
        const c = classes.find(cl => cl.id === s.classId);
        let row = [c?.name || '', s.name];
        if (actConfig.needsGender) row.push(s.gender);
        row.push(REPARTITIONS[dm.getRepartition(s.id, currentActivity)].label);

        actConfig.seqAFLPs.forEach((aflp, i) => {
            const config = actConfig.criteria[aflp];
            config.criteria.forEach(cr => {
                row.push(dm.getEvalLevel(s.id, currentActivity, aflp, cr.id));
                row.push(dm.getEvalScore(s.id, currentActivity, aflp, cr.id, cr, config.maxBase));
            });
            row.push(dm.calcAFLPScore(s.id, currentActivity, aflp, true, i));
        });
        actConfig.finAFLPs.forEach(aflp => {
            const config = actConfig.criteria[aflp];
            config.criteria.forEach(cr => {
                row.push(dm.getEvalLevel(s.id, currentActivity, aflp, cr.id));
                row.push(dm.getEvalScore(s.id, currentActivity, aflp, cr.id, cr, config.maxBase));
            });
            row.push(dm.calcAFLPScore(s.id, currentActivity, aflp, false));
        });
        row.push(dm.getSeqScore(s.id, currentActivity), dm.getFinScore(s.id, currentActivity), dm.getTotalScore(s.id, currentActivity));

        csv += row.join(',') + '\n';
    });

    downloadFile(`eval_${currentActivity}.csv`, csv, 'text/csv');
    showNotification('CSV export√© !');
}

function exportJSON() {
    downloadFile(`backup_eps_${new Date().toISOString().split('T')[0]}.json`, dm.exportJSON(), 'application/json');
    showNotification('Backup t√©l√©charg√© !');
}

function importJSON() {
    const file = document.getElementById('importFile').files[0];
    if (!file) return alert('S√©lectionnez un fichier');
    const reader = new FileReader();
    reader.onload = e => {
        if (dm.importJSON(e.target.result)) { showNotification('Import r√©ussi !'); location.reload(); }
        else alert('Erreur d\'import');
    };
    reader.readAsText(file);
}

function clearAllData() { dm.clearAll(); }

// ===== UTILITIES =====
function downloadFile(name, content, type) {
    const a = document.createElement('a');
    a.href = URL.createObjectURL(new Blob([content], { type }));
    a.download = name;
    a.click();
}

function showNotification(msg) {
    const n = document.createElement('div');
    n.className = 'notification';
    n.textContent = '‚úì ' + msg;
    document.body.appendChild(n);
    setTimeout(() => { n.style.opacity = '0'; setTimeout(() => n.remove(), 300); }, 2500);
}

function updateAllSelects() {
    const classes = dm.getClasses();
    ['selectClass', 'seqClass', 'finClass', 'resultsClass'].forEach(id => {
        const sel = document.getElementById(id);
        if (!sel) return;
        const val = sel.value;
        sel.innerHTML = '<option value="">-- Choisir --</option>' + classes.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
        sel.value = val;
    });
}

// ===== INIT =====
document.addEventListener('DOMContentLoaded', () => {
    selectActivity('badminton');
    updateAllSelects();
});
</script>
</body>
</html>
